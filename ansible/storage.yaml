- name: Increase Storage for User (Create text file)

  hosts: jailhost
    
  vars:
    ansible_user: arnav

    query_request: "{{ query }}"

    request_modifier: "{{ modifier }}"

    request_amount: "{{ amount | float}}"

    request_unit: "gb"

    request_target: "{{ target }}"

    request_action: "{{ 'increase' if (positive_action|bool == True) else 'decrease'}}"

    request_from: "{{ from }}"

    target_valid: "{{ valid_target }}"

    current_quota: '{{ (ansible_zfs_datasets[0].quota | replace("G", "")) | float}}'

    increase_amount: '{{(current_quota|float + request_amount|float) if request_modifier == "by" else request_amount|float }}'

  vars_files:
    - vars/credentials.yaml

  tasks:
    - name: User Storage Query
      community.general.zfs_facts:
        dataset: 'zroot/empt/homes/{{ request_target }}'
      when: target_valid | bool


    - name: Increase user storage 
      ansible.builtin.command: 'zfs set quota={{increase_amount}}G zroot/empt/homes/{{request_target}}'
      remote_user: ansible
      become: true
      become_method: community.general.doas
      when: not query_request and (target_valid|bool == True)

    - name: Send confirmation Email
      community.general.mail:
        host: smtp.gmail.com
        port: 465
        secure: always
        username: '{{ smtp_email }}'
        password: '{{ smtp_password }}'
        to: '{{ [ request_target ,  request_from ] | unique }}'
        from: '{{ smtp_email }}'
        subject: "Confirmation of {{ request_action }} storage request for user {{ request_target }}"
        body: "The storage quota for user {{ request_target }} has been {{request_action}}d {{ request_modifier }} {{ request_amount }} {{ request_unit }}"
      when: not query_request and (target_valid|bool == True) 
      delegate_to: localhost

    - name: Send query response
      community.general.mail:
        host: smtp.gmail.com
        port: 465
        secure: always
        username: '{{ smtp_email }}'
        password: '{{ smtp_password }}'
        to: '{{ [ request_target ,  request_from ] | unique }}'
        from: '{{ smtp_email }}'
        subject: "Storage query for user {{ request_target }}"
        body: "Your account has a quota (maximum space) of {{ ansible_zfs_datasets[0].quota }}, of which {{ ansible_zfs_datasets[0].reservation }} is already reserved. You have used {{ ansible_zfs_datasets[0].used }} so far."
      when: (query_request and target_valid) | bool
      delegate_to: localhost

    - name: Invalid target
      community.general.mail:
        host: smtp.gmail.com
        port: 465
        secure: always
        username: '{{ smtp_email }}'
        password: '{{ smtp_password }}'
        to: '{{ [ request_target ,  request_from ] | unique }}'
        from: '{{ smtp_email }}'
        subject: "Invalid target for your last storage request"
        body: "I'm sorry, but the user {{ target }} does not exist in this organization. Please check your spelling and/or read the documentation on how to use the storage request tool."
      when: not target_valid
      delegate_to: localhost
